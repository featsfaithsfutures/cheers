<html>
  <head>
    <title>Cheer Fi Mi</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!--script src="//ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.js"></script-->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="/socket.io/socket.io.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    
    <style type="text/css">
header{
	background:url('http://imageshack.com/a/img853/5536/ybf7.png') repeat-x #fff;
	height: 70px;
	width: 100%;
	margin: 0;
	border-bottom: 1px solid #eee;
}
body{
	background: #f3fbff;
	margin: 0px;
	}
.logo{
	background:url('http://imageshack.com/a/img42/1418/qqze.png') no-repeat;
	height: 70px;
	width: 200px;
	margin: auto;
}

.graph {
  background: green;
  padding: 0.2em;
  display:inline-block;
}

.entry {
  margin: 0.5em;

}

.name {
  display:inline-block;
  width: 20em;
  text-align: right;
  margin: 0.2em;
}
    </style>
  </head>
  <body>
  	<header>
	  	<div class="logo">
		  	
	  	</div>
  	</header>
    <input type="button" onclick="clearInterval(timer)" value="stop">
    <div id="leaderboard"></div>
  </body>
  <script>
  io = io.connect()
     
  var schools = []
  $.ajax({
    url: '/schools',
    dataType: 'json',
    success: function( json ) {
        $.each(json, function(i, name) {
            schools[i] = name
        });
    }
  })
  
  var timer = setInterval( function() {
    console.log("fetching leaderboard")
    io.emit('fetchLeaderBoard')
  }, 5000)
  
  console.log("setting up display")
  io.on('leaderBoard', function(data) {
    console.log("clearing")
    $("#leaderboard").html("")
    console.log("got leaderboard data")
    maxCheers = data.reduce(function(acc, item){
      if(item.cheers > acc) {
        return item.cheers
      } else {
        return acc
      }
    }, 0)
    
    maxLabelWidth= data.reduce(function(acc, item){
      if(schools[item.id].length > acc) {
        return schools[item.id].length
      } else {
        return acc
      }
    }, 0)
    console.log("max cheers = " + maxCheers)
    for(p in data){
       width = Math.floor(100 * data[p].cheers / maxCheers)
       entry = $("<div class='entry'></div>")
       label = $("<span class='name'></span>")
       label.css('width', maxLabelWidth/2 + "em")
       label.html(schools[data[p].id])
       console.log(entry)
       graph = $("<span class='graph'></span>")
       graph.css('width', width + 50 + "px") // 50 for minimum box size
       graph.html(data[p].cheers + " cheers")
       entry.append(label)
       entry.append(graph)
       $("#leaderboard").append(entry)
    }
  })
  

</script>
</html>